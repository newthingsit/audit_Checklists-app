on:
  pull_request:
  push:
    branches-ignore:
      - master

jobs:
  release-governance:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Validate release type declaration for mobile-impact PRs
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const COMMENT_MARKER = '<!-- release-governance-comment -->';

            const upsertPrComment = async ({ status, declaredType, suggestedType, note, mobileImpact, nativeOrConfigImpact }) => {
              if (!pr) return;

              const owner = context.repo.owner;
              const repo = context.repo.repo;
              const issue_number = pr.number;

              const body = [
                COMMENT_MARKER,
                '## Release Governance',
                '',
                `- Status: **${status}**`,
                `- Mobile-impact changes: **${mobileImpact ? 'Yes' : 'No'}**`,
                `- Declared Release-Type: **${declaredType || 'Not provided'}**`,
                `- Suggested Release-Type: **${suggestedType || 'N/A'}**`,
                `- Native/config impact: **${nativeOrConfigImpact ? 'Yes' : 'No'}**`,
                '',
                note,
              ].join('\n');

              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number,
                per_page: 100,
              });

              const existing = comments.find(c =>
                c.user?.type === 'Bot' && typeof c.body === 'string' && c.body.includes(COMMENT_MARKER)
              );

              if (existing) {
                await github.rest.issues.updateComment({
                  owner,
                  repo,
                  comment_id: existing.id,
                  body,
                });
                return;
              }

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            };

            const writeSummary = async ({ mobileImpact, declaredType, suggestedType, nativeOrConfigImpact, status, note, changedFiles = [] }) => {
              await core.summary
                .addHeading('Release Governance Summary')
                .addTable([
                  [{ data: 'Check', header: true }, { data: 'Result', header: true }],
                  ['Mobile-impact changes detected', mobileImpact ? 'Yes' : 'No'],
                  ['Declared Release-Type', declaredType || 'Not provided'],
                  ['Suggested Release-Type', suggestedType || 'N/A'],
                  ['Native/config impact detected', nativeOrConfigImpact ? 'Yes' : 'No'],
                  ['Status', status],
                ])
                .addRaw(`\n${note}\n`)
                .addRaw('\nChanged files considered for release governance:\n')
                .addList(changedFiles.length ? changedFiles : ['(none)'])
                .write();
            };

            if (!pr) {
              core.info('No pull request context found. Skipping release governance check.');
              await writeSummary({
                mobileImpact: false,
                declaredType: null,
                nativeOrConfigImpact: false,
                status: 'Skipped',
                note: 'No pull request context available.',
              });
              await upsertPrComment({
                status: 'Skipped',
                declaredType: null,
                suggestedType: null,
                note: 'No pull request context available.',
                mobileImpact: false,
                nativeOrConfigImpact: false,
              });
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = pr.number;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100
            });

            const changedFiles = files.map(f => f.filename);
            const isNativeOrConfigFile = name =>
              name === 'app.json' ||
              name === 'mobile/app.json' ||
              name === 'eas.json' ||
              name === 'mobile/package.json' ||
              name.startsWith('mobile/android/') ||
              name.startsWith('mobile/ios/');

            const hasMobileImpact = changedFiles.some(name =>
              name.startsWith('mobile/') ||
              name === 'app.json' ||
              name === 'mobile/app.json' ||
              name === 'eas.json'
            );
            const hasNativeOrConfigImpact = changedFiles.some(isNativeOrConfigFile);
            const suggestedType = !hasMobileImpact ? null : (hasNativeOrConfigImpact ? 'APK' : 'OTA');

            if (!hasMobileImpact) {
              core.info('No mobile-impact files changed. Release type declaration not required.');
              await writeSummary({
                mobileImpact: false,
                declaredType: null,
                suggestedType,
                nativeOrConfigImpact: false,
                status: 'Pass',
                note: 'Release-Type declaration is not required because no mobile-impact files changed.',
                changedFiles,
              });
              await upsertPrComment({
                status: 'Pass',
                declaredType: null,
                suggestedType,
                note: 'No mobile-impact files changed. Release-Type declaration is not required.',
                mobileImpact: false,
                nativeOrConfigImpact: false,
              });
              return;
            }

            const prText = `${pr.title || ''}\n${pr.body || ''}`;
            const releaseTypeMatch = prText.match(/release[-_ ]?type\s*:\s*(apk|ota)/i);

            if (!releaseTypeMatch) {
              await writeSummary({
                mobileImpact: true,
                declaredType: null,
                suggestedType,
                nativeOrConfigImpact: hasNativeOrConfigImpact,
                status: 'Fail',
                note: `Add "Release-Type: APK" or "Release-Type: OTA" to PR title/body. Suggested: ${suggestedType}.`,
                changedFiles,
              });
              await upsertPrComment({
                status: 'Fail',
                declaredType: null,
                suggestedType,
                note: `Add "Release-Type: APK" or "Release-Type: OTA" to PR title/body. Suggested: ${suggestedType}.`,
                mobileImpact: true,
                nativeOrConfigImpact: hasNativeOrConfigImpact,
              });
              core.setFailed(
                'Mobile-impact PR detected. Add "Release-Type: APK" or "Release-Type: OTA" to PR title/body.'
              );
              return;
            }

            const declaredType = releaseTypeMatch[1].toUpperCase();
            core.info(`Declared release type: ${declaredType}`);

            if (declaredType === 'OTA' && hasNativeOrConfigImpact) {
              await writeSummary({
                mobileImpact: true,
                declaredType,
                suggestedType,
                nativeOrConfigImpact: true,
                status: 'Fail',
                note: 'OTA is not allowed when native/config files changed. Use "Release-Type: APK".',
                changedFiles,
              });
              await upsertPrComment({
                status: 'Fail',
                declaredType,
                suggestedType,
                note: 'OTA is not allowed when native/config files changed. Use "Release-Type: APK".',
                mobileImpact: true,
                nativeOrConfigImpact: true,
              });
              core.setFailed(
                'Invalid release type: OTA declared but native/config files changed. Use "Release-Type: APK".'
              );
              return;
            }

            await writeSummary({
              mobileImpact: true,
              declaredType,
              suggestedType,
              nativeOrConfigImpact: hasNativeOrConfigImpact,
              status: 'Pass',
              note: 'Release-Type declaration is valid for the current set of changed files.',
              changedFiles,
            });
            await upsertPrComment({
              status: 'Pass',
              declaredType,
              suggestedType,
              note: 'Release-Type declaration is valid for the current set of changed files.',
              mobileImpact: true,
              nativeOrConfigImpact: hasNativeOrConfigImpact,
            });

            core.info('Release governance check passed.');

  backend-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - name: Install backend dependencies
        run: npm ci
        working-directory: backend
      - name: Seed test data
        run: node tests/setup-test-data.js
        working-directory: backend
      - name: Start backend server
        run: nohup npm start > backend.log 2>&1 &
        working-directory: backend
      - name: Wait for backend
        run: |
          for i in {1..30}; do
            curl -fsS http://localhost:5000/api/health && exit 0
            sleep 2
          done
          echo "Backend failed to start"
          exit 1
      - name: Run backend tests
        run: npm test
        working-directory: backend
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs
          path: backend/backend.log

  web-tests:
    runs-on: ubuntu-latest
    needs: backend-tests
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            web/package-lock.json
      - name: Install backend dependencies
        run: npm ci
        working-directory: backend
      - name: Seed test data
        run: node tests/setup-test-data.js
        working-directory: backend
      - name: Start backend server
        run: nohup npm start > backend.log 2>&1 &
        working-directory: backend
      - name: Wait for backend
        run: |
          for i in {1..30}; do
            curl -fsS http://localhost:5000/api/health && exit 0
            sleep 2
          done
          echo "Backend failed to start"
          exit 1
      - name: Install web dependencies
        run: npm ci
        working-directory: web
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        working-directory: web
      - name: Run web unit tests
        run: npm test -- --watchAll=false --passWithNoTests
        working-directory: web
      - name: Run web E2E tests
        run: |
          if [ -z "$E2E_EMAIL" ] || [ -z "$E2E_PASSWORD" ]; then
            echo "Skipping E2E tests: E2E_EMAIL/E2E_PASSWORD secrets are not configured"
            exit 0
          fi
          npm run test:e2e
        working-directory: web
        env:
          E2E_EMAIL: ${{ secrets.E2E_EMAIL }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          E2E_API_URL: http://localhost:5000
          E2E_BASE_URL: http://localhost:3000
      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: web/playwright-report
      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs-web
          path: backend/backend.log

  mobile-tests:
    needs: release-governance
    if: ${{ github.event_name != 'pull_request' || needs.release-governance.result == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      - name: Validate Expo config parity
        run: node scripts/check-expo-config-parity.js
      - name: Install mobile dependencies
        run: npm ci
        working-directory: mobile
      - name: Run mobile logic tests
        run: npm test
        working-directory: mobile
